<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ æ¤œç´¢</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1 class="text-4xl font-extrabold text-gray-900 tracking-wide">ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ æ¤œç´¢</h1>
    
    <!-- Googleãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´  -->
    <div id="map"></div>

    <script>
      function initMap() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ï¼ˆæ±äº¬ï¼‰
        const defaultLocation = { lat: 35.682839, lng: 139.759455 };

        // ãƒãƒƒãƒ—ã®ä½œæˆï¼ˆmapId ã¯ Google Cloud Console ã§è¨­å®šï¼‰
        const map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 13,
          mapId: "DEMO_MAP_ID"  // ã“ã“ã« **Google Cloud Console ã§è¨­å®šã—ãŸãƒãƒƒãƒ—ID** ã‚’å…¥ã‚Œã‚‹
        });

        // ç¾åœ¨åœ°å–å¾—
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              console.log("ç¾åœ¨åœ°å–å¾—æˆåŠŸ:", userLocation);

              // **ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆé’ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ï¼‰**
              new google.maps.marker.AdvancedMarkerElement({
                position: userLocation,
                map: map,
                title: "ç¾åœ¨åœ°",
              });

              map.setCenter(userLocation);
              findGyms(userLocation, map);
            },
            (error) => {
              console.error("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", error);
              alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
          );
        } else {
          alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
        }
      }

      // **ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ ã‚’æ¤œç´¢ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚’é…ç½®**
      function findGyms(location, map) {
        console.log("ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ æ¤œç´¢é–‹å§‹:", location);

        const service = new google.maps.places.PlacesService(map);
        const request = {
          location: location,
          radius: 5000, // **æ¤œç´¢åŠå¾„ 5km**
          type: "gym", // **Google Places API ã§ "gym" ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š**
          keyword: "ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹, ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ , ã‚¸ãƒ , ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¯ãƒ©ãƒ–" // **ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ ã«ç‰¹åŒ–**
        };

        service.nearbySearch(request, (results, status) => {
          console.log("Nearby search status:", status);

          if (status !== google.maps.places.PlacesServiceStatus.OK) {
            console.error("ã‚¸ãƒ ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ:", status);
            alert(`ã‚¸ãƒ ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ${status}`);
            return;
          }

          if (!results || results.length === 0) {
            console.warn("ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            alert("ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢ç¯„å›²ã‚’åºƒã’ã¦ã¿ã¦ãã ã•ã„ã€‚");
            return;
          }

          const infoWindow = new google.maps.InfoWindow();

          results.forEach((place, index) => {
            console.log("è¦‹ã¤ã‹ã£ãŸã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ :", place.name, place);

            // **ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚’é©ç”¨ï¼ˆè‰²åˆ†ã‘ï¼‰**
            const pinColors = ["red", "orange", "yellow", "blue", "purple"];
            const color = pinColors[index % pinColors.length]; // è‰²ã‚’é †ç•ªã«å‰²ã‚Šå½“ã¦
            const customIcon = {
              url: `https://maps.google.com/mapfiles/kml/paddle/${color}-stars.png`, // ã‚¸ãƒ ã®ãƒ”ãƒ³
              scaledSize: new google.maps.Size(50, 50), // **ã‚µã‚¤ã‚ºèª¿æ•´**
            };

            const marker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: map,
              title: place.name,
            });

            // **ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º**
            marker.addListener("click", () => {
              infoWindow.setContent(`
                <div style="font-size: 16px; font-weight: bold;">
                  ğŸ‹ï¸â€â™‚ï¸ <strong>${place.name}</strong><br>
                  ğŸ“ ${place.vicinity}<br>
                  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}" 
                    target="_blank" 
                    style="color: blue; text-decoration: underline;">
                    ğŸ” Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹
                  </a>
                </div>
              `);
              infoWindow.open(map, marker);
            });
          });
        });
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.google_maps[:api_key] %>&libraries=places,marker&callback=initMap"
      async
      defer
      loading="async"
    ></script>
</body>
</html>
