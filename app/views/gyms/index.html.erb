<h1 class="text-4xl font-extrabold text-gray-900 tracking-wide">ã‚¸ãƒ æ¤œç´¢</h1>

<!-- Googleãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´  -->
<div id="map" style="height: 600px; width: 100%;"></div>

<script>
  function initMap() {
    // æ±äº¬ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™
    const defaultLocation = { lat: 35.682839, lng: 139.759455 };

    // ãƒãƒƒãƒ—ã®ä½œæˆ
    const map = new google.maps.Map(document.getElementById("map"), {
      center: defaultLocation,
      zoom: 13,
    });

    // ç¾åœ¨åœ°å–å¾—
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          console.log("ç¾åœ¨åœ°å–å¾—æˆåŠŸ:", userLocation);

          // **ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆé’ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ï¼‰**
          new google.maps.Marker({
            position: userLocation,
            map: map,
            title: "ç¾åœ¨åœ°",
            icon: {
              url: "https://maps.google.com/mapfiles/kml/paddle/blu-circle.png", // ç¾åœ¨åœ°ãƒ”ãƒ³
              scaledSize: new google.maps.Size(50, 50),
            },
          });

          map.setCenter(userLocation);
          findGyms(userLocation, map);
        },
        (error) => {
          console.error("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", error);
          alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      );
    } else {
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
    }
  }

  // **ã‚¸ãƒ ã‚’æ¤œç´¢ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚’é…ç½®**
  function findGyms(location, map) {
    console.log("ã‚¸ãƒ æ¤œç´¢é–‹å§‹:", location);

    const service = new google.maps.places.PlacesService(map);
    const request = {
      location: location,
      radius: 5000, // **æ¤œç´¢åŠå¾„ 5km**
      type: ["gym"], // **ã‚¸ãƒ ã‚’æ¤œç´¢**
    };

    service.nearbySearch(request, (results, status) => {
      console.log("Nearby search status:", status);
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        const infoWindow = new google.maps.InfoWindow();

        results.forEach((place, index) => {
          console.log("è¦‹ã¤ã‹ã£ãŸã‚¸ãƒ :", place.name);

          // **ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚’é©ç”¨ï¼ˆè‰²åˆ†ã‘ï¼‰**
          const pinColors = ["red", "orange", "yellow", "blue", "purple"];
          const color = pinColors[index % pinColors.length]; // è‰²ã‚’é †ç•ªã«å‰²ã‚Šå½“ã¦
          const customIcon = {
            url: `https://maps.google.com/mapfiles/kml/paddle/${color}-stars.png`, // ã‚¸ãƒ ã®ãƒ”ãƒ³
            scaledSize: new google.maps.Size(50, 50), // **ã‚µã‚¤ã‚ºèª¿æ•´**
          };

          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: customIcon, // **ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³é©ç”¨**
          });

          // **ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º**
          marker.addListener("click", () => {
            infoWindow.setContent(`
              <div style="font-size: 16px; font-weight: bold;">
                ğŸ‹ï¸â€â™‚ï¸ <strong>${place.name}</strong><br>
                ğŸ“ ${place.vicinity}<br>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}" 
                   target="_blank" 
                   style="color: blue; text-decoration: underline;">
                  ğŸ” Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹
                </a>
              </div>
            `);
            infoWindow.open(map, marker);
          });
        });
      } else {
        console.error("ã‚¸ãƒ ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ:", status);
        alert("ã‚¸ãƒ ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });
  }
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.google_maps[:api_key] %>&libraries=places&callback=initMap"
  async
  defer
></script>
