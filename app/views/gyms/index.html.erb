<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スポーツジム検索</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1 class="text-4xl font-extrabold text-gray-900 tracking-wide">スポーツジム検索</h1>
    
    <!-- Googleマップを表示する要素 -->
    <div id="map"></div>

    <script>
      function initMap() {
        // デフォルトの位置（東京）
        const defaultLocation = { lat: 35.682839, lng: 139.759455 };

        // マップの作成（mapId は Google Cloud Console で設定）
        const map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 13,
          mapId: "DEMO_MAP_ID"  // ここに **Google Cloud Console で設定したマップID** を入れる
        });

        // 現在地取得
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              console.log("現在地取得成功:", userLocation);

              // **現在地マーカー（青のカスタムピン）**
              new google.maps.marker.AdvancedMarkerElement({
                position: userLocation,
                map: map,
                title: "現在地",
              });

              map.setCenter(userLocation);
              findGyms(userLocation, map);
            },
            (error) => {
              console.error("位置情報の取得に失敗しました", error);
              alert("位置情報の取得に失敗しました。位置情報の許可を確認してください。");
            }
          );
        } else {
          alert("このブラウザは位置情報をサポートしていません。");
        }
      }

      // **スポーツジムを検索してカスタムピンを配置**
      function findGyms(location, map) {
        console.log("スポーツジム検索開始:", location);

        const service = new google.maps.places.PlacesService(map);
        const request = {
          location: location,
          radius: 5000, // **検索半径 5km**
          type: "gym", // **Google Places API で "gym" タイプを指定**
          keyword: "フィットネス, スポーツジム, ジム, フィットネスクラブ" // **スポーツジムに特化**
        };

        service.nearbySearch(request, (results, status) => {
          console.log("Nearby search status:", status);

          if (status !== google.maps.places.PlacesServiceStatus.OK) {
            console.error("ジムの検索に失敗しました:", status);
            alert(`ジムの検索に失敗しました。エラー: ${status}`);
            return;
          }

          if (!results || results.length === 0) {
            console.warn("スポーツジムが見つかりませんでした。");
            alert("スポーツジムが見つかりませんでした。検索範囲を広げてみてください。");
            return;
          }

          const infoWindow = new google.maps.InfoWindow();

          results.forEach((place, index) => {
            console.log("見つかったスポーツジム:", place.name, place);

            // **カスタムピンを適用（色分け）**
            const pinColors = ["red", "orange", "yellow", "blue", "purple"];
            const color = pinColors[index % pinColors.length]; // 色を順番に割り当て
            const customIcon = {
              url: `https://maps.google.com/mapfiles/kml/paddle/${color}-stars.png`, // ジムのピン
              scaledSize: new google.maps.Size(50, 50), // **サイズ調整**
            };

            const marker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: map,
              title: place.name,
            });

            // **クリック時に詳細情報を表示**
            marker.addListener("click", () => {
              infoWindow.setContent(`
                <div style="font-size: 16px; font-weight: bold;">
                  🏋️‍♂️ <strong>${place.name}</strong><br>
                  📍 ${place.vicinity}<br>
                  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}" 
                    target="_blank" 
                    style="color: blue; text-decoration: underline;">
                    🔍 Googleマップで見る
                  </a>
                </div>
              `);
              infoWindow.open(map, marker);
            });
          });
        });
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.google_maps[:api_key] %>&libraries=places,marker&callback=initMap"
      async
      defer
      loading="async"
    ></script>
</body>
</html>
